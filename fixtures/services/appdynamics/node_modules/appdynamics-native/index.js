/*
Copyright (c) AppDynamics, Inc., and its affiliates
2015
All Rights Reserved
*/
function tryRequire(moduleName)
{
   var fullPath;
   try {
       fullPath = require.resolve(moduleName);
   }
   catch (e) {
       return undefined;
   }
   return require(fullPath);
}

function requireBinding()
{
   var locations = [ './build/Release/appdynamics',
                     './build/Debug/appdynamics'];
   for (var i = 0; i < locations.length; i++) {
       var zmq = tryRequire(locations[i]);
       if (zmq)
           return zmq;
   }
   // Try the last location without first
   // checking if that locations exists.
   return require('./appdynamics');
}


function load(agent)
{
    try {
      var appDNative = requireBinding();
      if(
        !appDNative ||
        !appDNative.cpuTime ||
        !appDNative.cpuTime()
      ) {
        throw new Error("Failed loading native extention.");
      }
      else {
        agent.logger.debug("Loaded native extention.");
      }
      return appDNative;
    }
    catch(err) {
      agent.logger.error(err);
      agent.logger.error(
        "Compilation or installation of native extention failed and " +
        "precompiled package was not available or had no matching version. " +
        "Please try the latest version of \"appdynamics\". " +
        "Alternatively, you can continue using AppDynamics without the native extention, " +
        "but will be missing several core features."
      );
    }
}


module.exports = {
    "load" : load
};
